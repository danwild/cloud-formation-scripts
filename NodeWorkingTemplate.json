{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation My Node Template",
  "Parameters": {
	"KeyName": {
	  "Description": "Name of an existing EC2 KeyPair to enable SSH access to the AWS Elastic Beanstalk instance",
	  "Type": "AWS::EC2::KeyPair::KeyName",
	  "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
	}
  },
  "Mappings": {
	"Region2Principal": {
	  "us-east-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "us-west-2": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "us-west-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "eu-west-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "ap-southeast-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "ap-northeast-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "ap-northeast-2": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "ap-southeast-2": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "sa-east-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  },
	  "cn-north-1": {
		"EC2Principal": "ec2.amazonaws.com.cn",
		"OpsWorksPrincipal": "opsworks.amazonaws.com.cn"
	  },
	  "eu-central-1": {
		"EC2Principal": "ec2.amazonaws.com",
		"OpsWorksPrincipal": "opsworks.amazonaws.com"
	  }
	}
  },
  "Resources": {
	"WebServerRole": {
	  "Type": "AWS::IAM::Role",
	  "Properties": {
		"AssumeRolePolicyDocument": {
		  "Statement": [
			{
			  "Effect": "Allow",
			  "Principal": {
				"Service": [
				  {
					"Fn::FindInMap": [
					  "Region2Principal",
					  {
						"Ref": "AWS::Region"
					  },
					  "EC2Principal"
					]
				  }
				]
			  },
			  "Action": [
				"sts:AssumeRole"
			  ]
			}
		  ]
		},
		"Path": "/"
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "293aed53-b979-49e2-a8fe-6821cf81b067"
		}
	  }
	},
	"WebServerRolePolicy": {
	  "Type": "AWS::IAM::Policy",
	  "Properties": {
		"PolicyName": "WebServerRole",
		"PolicyDocument": {
		  "Statement": [
			{
			  "Effect": "Allow",
			  "NotAction": "iam:*",
			  "Resource": "*"
			}
		  ]
		},
		"Roles": [
		  {
			"Ref": "WebServerRole"
		  }
		]
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "3d612ddb-b25e-43ae-8493-c58052d279e2"
		}
	  }
	},
	"WebServerInstanceProfile": {
	  "Type": "AWS::IAM::InstanceProfile",
	  "Properties": {
		"Path": "/",
		"Roles": [
		  {
			"Ref": "WebServerRole"
		  }
		]
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "c6582669-767e-4be5-a389-9034083da6b3"
		}
	  }
	},
	"MyApplication": {
	  "Type": "AWS::ElasticBeanstalk::Application",
	  "Properties": {
		"Description": "NodeWorking - AWS Elastic Beanstalk Node.js Application"
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "a2e3cae9-767a-46a2-ae3c-9d4bb9d44afb"
		}
	  }
	},
	"MyApplicationVersion": {
	  "Type": "AWS::ElasticBeanstalk::ApplicationVersion",
	  "Properties": {
		"Description": "Version 1.0",
		"ApplicationName": {
		  "Ref": "MyApplication"
		},
		"SourceBundle": {
		  "S3Bucket": "danwild-node-working",
		  "S3Key": "node-working.zip"
		}
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "73d8481e-4726-444a-b69b-6faf2a6c1cba"
		}
	  }
	},
	"MyConfigurationTemplate": {
	  "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
	  "Properties": {
		"ApplicationName": {
		  "Ref": "MyApplication"
		},
		"Description": "SSH access to Node.JS Application",
		"SolutionStackName": "64bit Amazon Linux 2015.09 v2.0.6 running Node.js",
		"OptionSettings": [
		  {
			"Namespace": "aws:autoscaling:launchconfiguration",
			"OptionName": "EC2KeyName",
			"Value": {
			  "Ref": "KeyName"
			}
		  },
		  {
			"Namespace": "aws:autoscaling:launchconfiguration",
			"OptionName": "IamInstanceProfile",
			"Value": {
			  "Ref": "WebServerInstanceProfile"
			}
		  }
		]
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "6888e34a-fbf6-4934-a783-5924956306e4"
		}
	  }
	},
	"MyEnvironment": {
	  "Type": "AWS::ElasticBeanstalk::Environment",
	  "Properties": {
		"Description": "AWS Elastic Beanstalk Environment running My Node.js Application",
		"ApplicationName": {
		  "Ref": "MyApplication"
		},
		"TemplateName": {
		  "Ref": "MyConfigurationTemplate"
		},
		"VersionLabel": {
		  "Ref": "MyApplicationVersion"
		}
	  },
	  "Metadata": {
		"AWS::CloudFormation::Designer": {
		  "id": "a079b7bf-2f09-4b23-9dbc-953590142ae8"
		}
	  }
	}
  },
  "Outputs": {
	"URL": {
	  "Description": "URL of the AWS Elastic Beanstalk Environment",
	  "Value": {
		"Fn::Join": [
		  "",
		  [
			"http://",
			{
			  "Fn::GetAtt": [
				"MyEnvironment",
				"EndpointURL"
			  ]
			}
		  ]
		]
	  }
	}
  }
}